<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="公交线路与公交车站浏览器(DEV)"
             author="Fei Chen"
             author_email="chinamaps-devtools+stadiaexplorer@google.com"
             author_affiliation="Google Inc."
             description="This is a tool for users to browse bus stops and routes."
             height="300">
  <Require feature="sharedmap" />
</ModulePrefs>

<Content type="html"><![CDATA[
<script type="text/javascript">
try {
  document.execCommand("BackgroundImageCache", false, true);
} catch(err) {}
</script>
<script src="http://www.google.com/jsapi?key=ABQIAAAA91OZMiOe8VfhdtstxQrBBxTqQ5WtUwE0C8FR1hRk-yj3qFOmhhToKuCkHwzulUTwzU6LJb92tmbOKA"></script>
<style type="text/css">
body{
	font-size:13px;
	font-family:Arial,sans-serif;
	color:#000;
	background:#fff
}
p,div,ul,li{
  margin:0;
  padding:0;
  border:0;
}
a{color:#00c;font-size:0.9em;} 
a:active{color:#f00} 
a:visited{color:#00c}
.transit{
  width:300px;
  height:300px;
}
.lineHead{
  margin: 0 0 10px 5px;
  padding: 0 0 10px 0px;
  border-bottom:#666 solid 1px;
  position:relative;
}
.searchBox{
  margin:0;
  width:100px;
  color:#808080;
}
.searchButton{
  margin:0 15px 0 -3px;
  font-size:14px;
}
.liveCity{
 	width:60px;
	border:0;
	border-bottom:solid 1px #333;
 }
.messageBoard, .searchPane{
  position:absolute;
  top:30px;
  background-color:#fff;
  border:solid #333333 1px;
  padding:3px;
  width:90%;
  z-index:100;
  display:none;
}
#lineSearchResult, #citySearchResult{
  overflow-y:auto;
}
.lineName, .list-line-name{
  font-weight:bold;
  font-size:1.2em;
  border:#666 solid 2px;
  padding:1px 2px;
}
.list-line-name{
  font-size:1em;
  border-width:1px;
}
.plyIcon{
  width:16px;
  height:9px;
  background:url("http://chinamaps.googlecode.com/svn/transit/icons/plyIcon.gif") no-repeat left center;
}
html>body .plyIcon{
  padding:2px 8px;
}
.lineDescript{
  margin: 5px 0;
  font-size:1.1em;
}
.stopIcon{
  padding-left: 20px;
  background:url("http://chinamaps.googlecode.com/svn/transit/icons/blueStopIcon.png") no-repeat 0 50%;
}
.stationName{
  font-weight:bold;
  font-size:1.2em;
  margin:10px 0 5px 0;
}
.closeIcon{
  text-align:right;
  font-weight:bold;
  padding:1px 3px;margin-left:95%;
}
#linePaneContent, #stopPaneContent{
  height:300px;
  overflow-y:auto;
}
</style>
<div class="transit">
  <div class="lineHead" id="lineHead">
    <input type="text" id="lineBox" class="searchBox" value="输入公交线路名" onmouseover="this.select()" onclick="this.value=''" onkeyup="Transit.searchLine(id)" onfocus="style.color='#000'" onblur="Transit.restore(id, 1);style.color='#808080'"/>
    <input type="button" class="searchButton" value="查" onclick="Transit.searchLine('lineBox')"/>
	城市
	<input id="liveCity" class="liveCity" onkeyup="Transit.searchCity(id)" onmouseover="this.select()" onclick="this.value=''" onblur="Transit.restore(id, 2)"/>
	<span onclick="Transit.click_tri()">▼</span>
	
	<div id="lineSearchPane" class="searchPane" style="overflow-x:auto;">
	  <span class="closeIcon" onclick="this.parentNode.style.display='none'" onmouseover="style.backgroundColor='#c0c0c0';style.cursor='pointer'" onmouseout="style.backgroundColor='#fff';">X</span>
	  <div id="lineSearchResult">路线搜索结果</div>
	</div>
    <div id="citySearchPane" class="searchPane">
      <span class="closeIcon" onclick="this.parentNode.style.display='none'" onmouseover="style.backgroundColor='#c0c0c0';style.cursor='pointer'" onmouseout="style.backgroundColor='#fff';">X</span>
      <div id="citySearchResult">城市搜索结果</div>
    </div>
	<div id="msgBoard" class="messageBoard">消息框</div>
  </div>
  <div id="linePane" style="display:none">
  	<a href="javascript:Transit.click_back()" id="backStop" style="display:none;">返回某条路线</a>
	<div class="stationName stopIcon" id="stationName">车站名</div>
	<p style="font-size:0.9em;color:#666">经过本站的公交线路：</p>
	<div id="linePaneContent">路线列表</div>
  </div>
  <div id="stopPane" style="display:none">
  	<div>
	  <span id="lineName" class="lineName">路线名</span><a href="javascript:Transit.click_inverse()" style="margin:1em 0 0 1em;">查看返程</a>
	</div><div style="clear:both"></div>
	<div class="lineDescript">
    	<span id="lineStart">起点</span><a class="plyIcon"></a><span id="lineEnd">终点</span>
    </div>
	<div id="stopPaneContent">车站列表</div>
  </div>
</div>
<script type="text/javascript">
/**
 * @author Fei Chen
 * Latest update:
 */
(function(){
var $ = function(id){
  return document.getElementById(id);
}
/**
 * A Singletom class as a request proxy
 */
var rpcProxy = (function(){
  // Private member
  var backend_url = "http://211.157.3.197:8080/transit/";
  var msgBoard = $("msgBoard");
  
  function getParamStr(paramObj){
    var paramArray = [];
    for (var i in paramObj) {
      if (i != "toJSONString") {
        var paramToken = i + '=' + paramObj[i];
        paramArray.push(paramToken);
      }
    }
    return paramArray.join("&");
  }
  function request(param, callBackName){
    var paramStr = getParamStr(param);
    var url = backend_url + "?" + paramStr + "&random=" + Math.random();
    url += '&callback=' + callBackName;
    var api = param['api'];
    var scriptTag = document.createElement('script');
    scriptTag.setAttribute('type', 'text/javascript');
    scriptTag.setAttribute('charset', 'utf-8');
    scriptTag.setAttribute('id', 'jsonpScriptTag' + api);
    scriptTag.setAttribute('src', url);
    var oldTag = document.getElementById('jsonpScriptTag' + api);
    var head = document.getElementsByTagName('head')[0];
    if (oldTag) {
      head.removeChild(oldTag);
    }
    head.appendChild(scriptTag);
  }
  function openMsgBoard(msg) {
  	if(!msg) msg = "数据加载中...";
  	msgBoard.style.display = 'block';
    msgBoard.innerHTML = msg;
  }

  function closeMsgBoard(){
    msgBoard.style.display = 'none';
  }
  return {  // Public members
    getCities:function(){
      openMsgBoard();
      var param = {
        api : 'lc'
      }
      request(param, 'Transit.callback_lc');
    },
    getLinesByCity:function(cityName){
      openMsgBoard();
      var param = {
        api: 'cl',
        city: encodeURIComponent(cityName)
      };
      request(param, 'Transit.callback_cl');
    },
    getLinesByStation:function(stationName, cityName){
      openMsgBoard();
      var param = {
        api: 'ls',
        sn: encodeURIComponent(stationName),
        city: encodeURIComponent(cityName)
      };
      request(param, 'Transit.callback_ls');
    },
    getStopsByLine:function(lineId, cityName){
      openMsgBoard();
      var param = {
        api: 'sl',
        li: lineId,
        city: encodeURIComponent(cityName)
      };
      request(param, 'Transit.callback_sl');
    },
    getStopsByBounds:function(bounds){
      openMsgBoard();
      var bt = bounds.getNorthEast().lat();
      var bl = bounds.getSouthWest().lng();
      var bb = bounds.getSouthWest().lat();
      var br = bounds.getNorthEast().lng();
      var params = {
        api: 'sib',
        bt: bt,
        bl: bl,
        bb: bb,
        br: br
      };
      request(params, 'Transit.callback_sib');
    },
    getCitiesCallback:function(cities){
      transitMgr.importCities(cities);
      closeMsgBoard();
    },
    getLinesByCityCallback:function(lines){
      transitMgr.importCityLines(lines);
      closeMsgBoard();
    },
    getLinesByStationCallback : function(lines){
      transitMgr.importStationLines(lines);
      closeMsgBoard();
    },
    getStopsByLineCallback : function(stops){
      transitMgr.importLineStops(stops);
      closeMsgBoard();
    },
    getStopsByBoundsCallback : function(stops){
      transitMgr.importBoundsStops(stops);
      closeMsgBoard();
    }
  }
})();

var domUtil = (function(){
  var boundsStops = {};
  var blueIcon = createIcon("blueStopIcon.png");
  var redIcon = createIcon("redStopIcon.png");
  
  function createIcon(image) {
  	var baseUrl = "http://chinamaps.googlecode.com/svn/transit/icons/";
    var icon = new GIcon();
    icon.image = baseUrl + image;
    icon.iconSize = new GSize(16, 16);
    icon.iconAnchor = new GPoint(8, 8);
    icon.infoWindowAnchor = new GPoint(8, 4);
    return icon;
  }
  function addMarkerListener(marker, name){
    GEvent.addListener(marker, 'click', function() {
      openStopInfoWindow(marker, name);
      highlightStopNode(name);
      transitMgr.clickStop(name, true);
    });
  }
  function openStopInfoWindow(marker, name){
    var html = '<div style="font-weight:bold;font-size:1.2em;margin-bottom:3px;">' + name + '</div>';
    html += '<div style="font-size:0.8em;margin:10px 5px 5px 10px;color:#808080;">在左侧查看详细站点信息 &laquo;<div>';
    marker.openInfoWindowHtml(html);
  }
  function highlightStopNode(stopName){
    var curStopNode = $(stopName);
    if (curStopNode) {
      curStopNode.className = "selected";
//      scrollToVisible(curStopNode.parentNode); //TODO
    }
  }
  function createStopMarker(latlngStr, icon, name, map){
  	var result = latlngStr.split(",");
  	var point = new GLatLng(parseFloat(result[1]),parseFloat(result[0]));
  	var marker = new GMarker(point, { icon: icon, title: name});
  	if(map) map.addOverlay(marker);
    addMarkerListener(marker, name);
    return marker;
  }
  function transformStops(line, stops){
  	if(!line.stopList)
  	  line.stopList = {};
  	var points = [stops.length];
    for(var i = 0, item; item = stops[i]; i++){
      var name = item['name'];
      var stop = line.stopList[name] = {};
      stop.name = name;
      stop.seq = item['line_seq'];
      stop.marker = createStopMarker(item['coordinates'], redIcon, name);
      stop.marker.getPointAsync(function(point){
        points[item['line_seq']] = point;
      });
      
    }
    line.route = [];
    if (points.length > 1) {
      for (var i = 2, point; point = points[i]; i++) {
        var polyline = new GPolyline([points[i - 1], point], "#FF0033", 5, 1);
        line.route.push(polyline);
      }
    }
  }
  function closePopup(){
   $("citySearchPane").style.display = "none";
   $("lineSearchPane").style.display = "none";
  }
  function openPopup(id){
   $(id).style.display = "block";
  }
  return {
  	openLineSearchPane : function(lines, key){
  	  $("citySearchPane").style.display = "none";
      $("lineSearchPane").style.display = "block";
  	  var html = "";
  	  var counter = 0;
  	  var replacement = '<span style="font-weight:bold;">' + key + '</span>';
  	  for(var i in lines){
  	    html += '<div style="position:relative;margin:3px;" onclick=Transit.click_line(' + lines[i].id + ') onmouseover="style.backgroundColor=\'#c0c0c0\';style.cursor=\'pointer\'" onmouseout="style.backgroundColor=\'#fff\';">';
        html += '<p style="float:left;width:40%;">' + lines[i].name.replace(key, replacement) + '</p>';
        html += '<p style="float:right;width:55%;"><span style="display:block;color:#666;">（' + lines[i].start + '<a class="plyIcon"></a>' + lines[i].end + '）</span></p>';
  	    html += '<div style="clear:both"></div></div><div style="clear:both"></div>';
  	    counter ++;
  	  }
  	  if(html == ""){
  	    counter = 1;
  	    html = "没有找到匹配路线，换一个关键字试试...";
  	  }
  	  $("lineSearchResult").innerHTML = html;
  	  if(counter > 10){
  	    $("lineSearchResult").style.height = "15em";
  	  } else {
  	    $("lineSearchResult").style.height = "auto";
  	  }
  	},
  	openCitySearchPane : function(cities, key){
  	  $("citySearchPane").style.display = "block";
      $("lineSearchPane").style.display = "none";
  	  var html = "";
  	  var counter = 0;
  	  var lineCounter = 0;
  	  var replacement = '<span style="font-weight:bold;">' + key + '</span>';
  	  for(var i in cities){
  	  	var left = counter%4 * 70;
  	  	if(!left){
  	  	  html += "<div style='position:relative;margin:3px;top:"+counter/4*1.5+"em'>";
  	  	  lineCounter ++;
  	  	}
  	    html += "<p style='position:absolute;top:0;left:"+left+"px;padding:1px 3px;' onclick=Transit.click_city('"+i+"')  onmouseover='style.backgroundColor=\"#c0c0c0\";style.cursor=\"pointer\"' onmouseout='style.backgroundColor=\"#fff\";'>";
  	    html += i.replace(key, replacement) + "</p>";
  	    if(counter%4 == 3){
  	      html += "</div>";
  	    }
  	    counter ++;
  	  }
  	  if(html == ""){
  	    lineCounter = 1;
  	    html = "没有匹配城市，换一个关键字试试...";
  	  }
  	  $("citySearchResult").innerHTML = html;
  	  if(counter > 40){
  	    $("citySearchResult").style.height = "15em";
  	  } else {
  	    $("citySearchResult").style.height = lineCounter*1.5 + "em";
  	  }
  	},
    fillStationLines : function(stopName, lines, lineName){
      closePopup();
      $("stopPane").style.display = "none";
  	  $("linePane").style.display = "block";
  	  if (lineName) {
  	  	$("backStop").style.display = "block";
        $("backStop").innerHTML = "返回" + lineName;
      }
      $("stationName").innerHTML = stopName;
      var html = '';
      var existLines = {};
      for(var i = 0, item; item = lines[i]; i++){
  	    var id = item['line_id'];
  	    var name = item['short_name'];
  	    var start = item['start_station'];
  	    var end = item['end_station'];
  	    //NEW: filter duplicate line
  	    if(existLines[name]) continue;
  	    html += '<div style="position:relative;margin:5px 3px;">';
        html += '<p class="list-line-name" style="float:left;width:40%;" onclick=Transit.click_line(' + id + ') onmouseover="style.backgroundColor=\'#c0c0c0\';style.cursor=\'pointer\'" onmouseout="style.backgroundColor=\'#fff\';">' + name + '</p>';
        html += '<p style="float:right; width:57%;">' + start + '<a class="plyIcon"></a>' + end + '</p>';
        html += '<div style="clear:both"></div></div><div style="clear:both"></div>';
        existLines[name] = name;
      }
      $("linePaneContent").innerHTML = html;
    },
    fillLineStops : function(line, map, stops){
      closePopup();
      $("stopPane").style.display = "block";
  	  $("linePane").style.display = "none";
  	  $("lineName").innerHTML = line.name;
  	  $("lineStart").innerHTML = line.start;
  	  $("lineEnd").innerHTML = line.end;
  	  if(stops && !line.route){
  	    transformStops(line, stops);
  	  }
  	  var html = ''; 
  	  var bounds = new GLatLngBounds();
  	  for(var i = 0, polyline; polyline = line.route[i]; i++){
        map.addOverlay(polyline);
      }
      for(var i in line.stopList){
      	var stop = line.stopList[i];
        map.addOverlay(stop.marker);
      	html += '<p class="stopIcon" style="line-height:1.5em;" onclick="Transit.click_stop(\''+stop.name+'\')" onmouseover="style.fontWeight=\'bolder\';style.cursor=\'pointer\'" onmouseout="style.fontWeight=\'normal\';">';
    	html += '  <span style="text-align:center;width:15px;color:#666">'+stop.seq+'</span>';
    	html += '  <span id="'+stop.name+'">'+stop.name+'</span>';
    	html += '</p>';
    	bounds.extend(stop.marker.getLatLng());
      }
  	  $("stopPaneContent").innerHTML = html;
      var center = bounds.getCenter();
      map.getBoundsZoomLevelAsync(function(zoom){
        map.setCenter(center, zoom);
      });
      
    },
    displayBoundsStops : function(stops, lineStops, map){
      var tobeRemove = {};
      for(var i in boundsStops){
        tobeRemove[i] = boundsStops[i];
      }
      for(var i = 0, item; item = stops[i]; i++){
      	var name = item['name'];
      	if(lineStops[name]) continue;
        if(boundsStops[name]){
          delete tobeRemove[name];
        } else {
          var stop = {};
          stop.name = name;
          stop.marker = createStopMarker(item['coordinates'], blueIcon, name, map);
          boundsStops[name] = stop;
        }
      } 
      for(var i in tobeRemove){
        map.removeOverlay(tobeRemove[i].marker);
        delete boundsStops[i];
      }
    },
    hideBoundsStops : function(){
      for(var i in boundsStops){
        boundsStops[i].marker.hide();
      }
    },
    showBoundsStops : function(bounds){
      for(var i in boundsStops){
      	var marker = boundsStops[i].marker;
      	if(bounds.containsLatLng(marker.getLatLng())){
      	  marker.show();
      	}
      }
    },
    changeCity : function(cityName){
      closePopup();
      $('liveCity').value = cityName;
      $('linePane').style.display = 'none';
      $('stopPane').style.display = 'none';
      boundsStops = {};
    },
    highlightStop : function(stop){
      openStopInfoWindow(stop.marker, stop.name);
      highlightStopNode(stop.name);
    },
    clickBack : function(){
      $("stopPane").style.display = "block";
      $("linePane").style.display = "none";
    }
  }
})();

var transitMgr = (function(){
  var map = new GMap2();
  /**
   * Container of Objects below
   * City Object: cityName:{name: ***, latlng:***, lineList:{list of Line Object}}
   * Line Object: lineId:{id:***, name:***, start:***, end:***, stopList:{list of Stop Object}}
   * Stop Object: coordinate:{name:***, latlng:***, marker:***}
   */
  var cityList = {};
  var cur = {};
  var popupFlag = false;
  
  var MSIE = !!(window.attachEvent && !window.opera);
  var MAX_LEVEL = 17;
  var MIN_LEVEL = 15;
  var DEFAULT_LEVEL = MSIE ? 16 : 15;
  var DEFAULT_CENTER = new GLatLng(39.929, 116.388);  // Beijing
  var DEFAULT_CITY = "北京";
  
  function initMap(){
    var loc = google.loader.ClientLocation;
    if(loc && loc.address && loc.address.city && loc.latitude && loc.longitude){
      map.setCenter(new GLatLng(loc.latitude, loc.longitude), DEFAULT_LEVEL);
    } else {
      map.setCenter(DEFAULT_CENTER, DEFAULT_LEVEL);
    }
    addMapListener();
  }
  
  function addMapListener(){
    GEvent.addListener(map, "infowindowclose", function() {
      if(cur.lineId)  Transit.click_back();
    });

    GEvent.addListener(map, "zoomend", function(oldLevel, newLevel) {
      if (!isInVisible(newLevel)) {
        domUtil.hideBoundsStops();
      } else if (!isInVisible(oldLevel) && isInVisible(newLevel)) {
      	map.getBoundsAsync(function(bounds){
      	  domUtil.showBoundsStops(bounds);
          rpcProxy.getStopsByBounds(bounds);
      	});
      	
      }
    });

    GEvent.addListener(map, "moveend", function() {
      map.getZoomAsync(function(zoom){
        if (isInVisible(zoom)) {
          map.getBoundsAsync(function(bounds){
            rpcProxy.getStopsByBounds(bounds);
          });
        }
      });
    });
  }
  
  function isInVisible(zoom){
    if(zoom > MAX_LEVEL || zoom < MIN_LEVEL) return false;
    return true;
  }
  function checkCity(cityName, needRelocate){
    if(cityName != cur.cityName){
      cur = {};
      cur.cityName = cityName;
      domUtil.changeCity(cityName);
      rpcProxy.getLinesByCity(cityName);
    }
    if(needRelocate){
      map.clearOverlays();
      var point = getCityPosition(cityName);
      map.setCenter(point, DEFAULT_LEVEL);
    }
  }
  function getCityPosition(cityName){
  	var result = cityList[cityName].latlng.match(/\((\d+\.\d*),(\d+\.\d*)\)/);
	return new GLatLng(parseFloat(result[1]), parseFloat(result[2]));
  }
  
  return {
    init : function(){
      rpcProxy.getCities();
  	  initMap();
  	  map.getBoundsAsync(function(bounds){
  	    rpcProxy.getStopsByBounds(bounds);
  	  });
  	  
  	},
    importCities:function(cities){
  	  for(var i = 0, item; item = cities[i]; i++){
  	  	var name = item['city'];
  	  	if(!cityList[name]){
  	  	  var city = cityList[name] = {};
  	  	  city.name = name;
  	  	  city.latlng = item['coordinates'];
  	  	} else {
  	  	  // Debug
  	  	}
  	  }
  	},
    importCityLines:function(lines){
  	  var city = cityList[cur.cityName];
  	  var lineList = city.lineList = {};
  	  for(var i = 0, item; item = lines[i]; i++){
  	    var line = lineList[item['i']] = {};
  	    line.id = item['i'];
  	    line.name = item['n'];
  	    line.start = item['s'];
  	    line.end = item['e'];
  	  }
  	},
  	importLineStops : function(stops){
      var line = cityList[cur.cityName].lineList[cur.lineId];
      domUtil.fillLineStops(line, map, stops);
    },
    importBoundsStops : function(stops){
      if(stops && stops.length > 0){
        checkCity(stops[0].location);
      } else {
        map.setCenter(DEFAULT_CENTER, DEFAULT_LEVEL);
      }
      var lineStops = {};
      if(cur.cityName && cur.lineId){
        lineStops = cityList[cur.cityName].lineList[cur.lineId].stopList;
      }
      domUtil.displayBoundsStops(stops, lineStops, map);
    },
    importStationLines : function(lines){
  	  var stopName = cur.stopName;
  	  if(cur.lineId) var lineName = cityList[cur.cityName].lineList[cur.lineId].name;
  	  domUtil.fillStationLines(stopName, lines, lineName);
  	},
    clickLine : function(lineId, isFromSearch){
  	  if(isFromSearch){
  	    lineId = lineId.split("_")[1];
  	  }
  	  if(cur.lineId != lineId){
      	var oldLine = cityList[cur.cityName].lineList[cur.lineId];
      	if(oldLine && oldLine.stopList){
      	  var stops = oldLine.stopList;
      	  for(var i in stops) {
      	    map.removeOverlay(stops[i].marker);
      	  }
      	  for(var i = 0, polyline; polyline = oldLine.route[i]; i++){
      	    map.removeOverlay(polyline);
      	  }
      	  // BIG Question: if remove polyline first, the markers can not removed.
      	}
      	cur.lineId = lineId;
      }
      var newLine = cityList[cur.cityName].lineList[lineId];
      if(newLine && newLine.stopList){
        domUtil.fillLineStops(newLine, map);
      } else {
        rpcProxy.getStopsByLine(lineId, cur.cityName);
      }
    },
    clickStop : function(stopName, isMockClick){
      if(cur.stopName != stopName){
        var curStopNode = $(cur.stopName);
        if (curStopNode) {
          curStopNode.className = "";
        }
        cur.stopName = stopName;
      }
      rpcProxy.getLinesByStation(stopName, cur.cityName);
      if(!isMockClick){
        var stop = cityList[cur.cityName].lineList[cur.lineId].stopList[stopName];
        domUtil.highlightStop(stop);
      }
    },
    clickInverse : function(){
      var lines = cityList[cur.cityName].lineList;
      var id = cur.lineId;
  	  var name = lines[cur.lineId].name;
      for (var i in lines) {
        var line = lines[i];
        if (line.name == name && line.id != id) {
      	  transitMgr.clickLine(line.id);
      	  break;
        }
      }
    },
    clickTri : function(){
      domUtil.openCitySearchPane(cityList);
    },
    clickCity : function(cityName){
      checkCity(cityName, true);
    },
    searchLine : function(id){
      var key = $(id).value;
      if (key == null || key == "" || key == '输入公交线路名') {
        return;
      }
      var result = {};
      var lineList = cityList[cur.cityName].lineList;
      if(!lineList)  return;
      if (isNaN(parseInt(key))) {
        for (var i in lineList) {
          if(lineList[i].name.indexOf(key) != -1){
            result[i] = lineList[i];
          }
        }
      } else {
        for (var i in lineList) {
          if (lineList[i].name.match(/\d+/) == key) {
            result[i] = lineList[i];
          }
        }
      }
      domUtil.openLineSearchPane(result, key);
    },
    searchCity : function(id){
      var key = $(id).value;
      if (key == null || key == "") {
      	return;
      }
      var result = {};
      for(var i in cityList){
        if(i.indexOf(key) != -1){
          result[i] = cityList[i];
        }
      }
      domUtil.openCitySearchPane(result, key);
    },
    restore : function(id, type){
      var key = $(id).value;
      if (key == null || key == "") {
      	if(type == 1){
      	  $(id).value = "输入公交线路名";
      	}else if(type == 2){
      	  $(id).value = cur.cityName;
      	}
      }
    }
  }
})();

// Export global symbols.
// They are used for callback when got json results.
window['Transit'] = {
  'start' : transitMgr.init,
  'callback_ls':  rpcProxy.getLinesByStationCallback,
  'callback_sib': rpcProxy.getStopsByBoundsCallback,
  'callback_lc':  rpcProxy.getCitiesCallback,
  'callback_cl':  rpcProxy.getLinesByCityCallback,
  'callback_sl':  rpcProxy.getStopsByLineCallback,
  'click_stop' : transitMgr.clickStop,
  'click_line' : transitMgr.clickLine,
  'click_inverse' : transitMgr.clickInverse,
  'click_back' : domUtil.clickBack,
  'click_tri' : transitMgr.clickTri,
  'click_city' : transitMgr.clickCity,
  'searchLine' : transitMgr.searchLine,
  'searchCity' : transitMgr.searchCity,
  'restore' : transitMgr.restore
};
})()
_IG_RegisterOnloadHandler(Transit.start);
</script>
]]></Content>
</Module>
